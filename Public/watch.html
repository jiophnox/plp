<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Watch - YouTube</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', Arial, sans-serif;
      background-color: #0f0f0f;
      color: #fff;
      min-height: 100vh;
    }

    /* Header - Same as channel/search pages */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #0f0f0f;
      border-bottom: 1px solid #272727;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      z-index: 1000;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .menu-toggle {
      display: none;
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .menu-toggle:hover {
      background: #272727;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      color: #fff;
      font-size: 20px;
      font-weight: 700;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: #ff0000;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Search Bar - Desktop */
    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      max-width: 600px;
      padding: 0 16px;
    }

    .search-container {
      display: flex;
      width: 100%;
      max-width: 500px;
    }

    .search-input-wrapper {
      flex: 1;
      position: relative;
      display: flex;
    }

    .search-input {
      width: 100%;
      height: 40px;
      background: #121212;
      border: 1px solid #303030;
      border-radius: 20px 0 0 20px;
      padding: 0 16px;
      font-size: 16px;
      color: #fff;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .search-input:focus {
      border-color: #1c62b9;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.3);
    }

    .search-input::placeholder {
      color: #888;
    }

    .search-btn {
      height: 40px;
      width: 64px;
      background: #222;
      border: 1px solid #303030;
      border-left: none;
      border-radius: 0 20px 20px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .search-btn:hover {
      background: #333;
    }

    .search-btn svg {
      width: 24px;
      height: 24px;
      fill: #fff;
    }

    /* Header Right */
    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      flex-shrink: 0;
      min-width: 40px;
    }

    .mobile-search-btn {
      display: none;
      background: none;
      border: none;
      color: #fff;
      padding: 8px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
    }

    .mobile-search-btn:hover {
      background: #272727;
    }

    .mobile-search-btn svg {
      width: 24px;
      height: 24px;
      fill: #fff;
      display: block;
    }

    /* Mobile Search Bar */
    .mobile-search-container {
      display: none;
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      background: #0f0f0f;
      padding: 12px 16px;
      border-bottom: 1px solid #272727;
      z-index: 999;
      animation: slideDown 0.2s ease;
    }

    .mobile-search-container.open {
      display: block;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .mobile-search-wrapper {
      display: flex;
      gap: 8px;
    }

    .mobile-search-input {
      flex: 1;
      height: 40px;
      background: #121212;
      border: 1px solid #303030;
      border-radius: 20px;
      padding: 0 16px;
      font-size: 16px;
      color: #fff;
      outline: none;
    }

    .mobile-search-input:focus {
      border-color: #1c62b9;
    }

    .mobile-search-input::placeholder {
      color: #888;
    }

    .mobile-search-submit {
      height: 40px;
      width: 40px;
      background: #222;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      flex-shrink: 0;
    }

    .mobile-search-submit:hover {
      background: #333;
    }

    .mobile-search-submit svg {
      width: 20px;
      height: 20px;
      fill: #fff;
    }

    .mobile-search-close {
      height: 40px;
      width: 40px;
      background: none;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 24px;
      transition: background 0.2s;
      flex-shrink: 0;
    }

    .mobile-search-close:hover {
      background: #272727;
    }

    /* Left Menu - Same 150px as channel/search pages */
    .left-menu {
      position: fixed;
      top: 56px;
      left: 0;
      width: 150px;
      height: calc(100vh - 56px);
      background: #0f0f0f;
      border-right: 1px solid #272727;
      padding: 12px 0;
      overflow-y: auto;
      z-index: 999;
      transition: transform 0.3s ease;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .left-menu::-webkit-scrollbar {
      display: none;
    }

    .menu-overlay {
      display: none;
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      color: #fff;
      text-decoration: none;
      font-size: 13px;
      transition: background 0.2s;
      cursor: pointer;
    }

    .menu-item:hover {
      background: #272727;
    }

    .menu-item.active {
      background: #272727;
    }

    .menu-item-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .menu-divider {
      height: 1px;
      background: #272727;
      margin: 12px 0;
    }

    .menu-section-title {
      padding: 8px 16px;
      font-size: 11px;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Main Content Wrapper - Same 150px offset as channel/search pages */
    .main-wrapper {
      margin-left: 150px;
      padding-top: 56px;
      min-height: 100vh;
    }

    /* Loading State */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: calc(100vh - 56px);
      gap: 20px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #272727;
      border-top-color: #ff0000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Watch Layout */
    .watch-container {
      display: flex;
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
      gap: 24px;
    }

    /* Video Player Section */
    .player-section {
      flex: 1;
      min-width: 0;
    }

    .video-player-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }

    .video-player-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Player Placeholder */
    .player-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #aaa;
      text-align: center;
      padding: 40px;
    }

    .player-placeholder-icon {
      font-size: 64px;
      margin-bottom: 24px;
      opacity: 0.5;
    }

    .player-placeholder h2 {
      font-size: 24px;
      color: #fff;
      margin-bottom: 12px;
    }

    .player-placeholder p {
      font-size: 14px;
      max-width: 400px;
      line-height: 1.6;
    }

    /* Video Info */
    .video-info {
      padding: 16px 0;
    }

    .video-title {
      font-size: 20px;
      font-weight: 600;
      line-height: 1.4;
      margin-bottom: 12px;
      color: #f1f1f1;
    }

    .video-stats {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .video-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #aaa;
      font-size: 14px;
    }

    .video-meta span::after {
      content: '‚Ä¢';
      margin-left: 8px;
    }

    .video-meta span:last-child::after {
      content: '';
    }

    .video-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: #272727;
      border: none;
      border-radius: 20px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .action-btn:hover {
      background: #3f3f3f;
    }

    .action-btn.liked {
      background: #3ea6ff;
      color: #000;
    }

    .action-btn.active {
      background: #fff;
      color: #000;
    }

    /* Channel Info */
    .channel-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid #272727;
      flex-wrap: wrap;
      gap: 12px;
    }

    .channel-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .channel-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #333;
      object-fit: cover;
    }

    .channel-details h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .channel-details h3 a {
      color: #fff;
      text-decoration: none;
      transition: color 0.2s;
    }

    .channel-details h3 a:hover {
      color: #3ea6ff;
    }

    .channel-subs {
      font-size: 12px;
      color: #aaa;
    }

    .channel-buttons {
      display: flex;
      gap: 8px;
    }

    .subscribe-btn {
      padding: 10px 20px;
      background: #fff;
      color: #0f0f0f;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .subscribe-btn:hover {
      background: #d9d9d9;
    }

    .subscribe-btn.subscribed {
      background: #272727;
      color: #fff;
    }

    /* Description */
    .description-box {
      background: #272727;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .description-box:hover {
      background: #3f3f3f;
    }

    .description-box.expanded {
      cursor: default;
    }

    .description-box.expanded:hover {
      background: #272727;
    }

    .description-meta {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #f1f1f1;
    }

    .description-text {
      font-size: 14px;
      line-height: 1.6;
      color: #f1f1f1;
      white-space: pre-wrap;
    }

    .description-text:not(.expanded) {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .description-text.expanded {
      -webkit-line-clamp: unset;
    }

    .show-more-btn {
      background: none;
      border: none;
      color: #aaa;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 12px;
      padding: 0;
    }

    .show-more-btn:hover {
      color: #fff;
    }

    /* Sidebar - Related Videos / Playlist */
    .sidebar {
      width: 400px;
      flex-shrink: 0;
    }

    /* Quick Actions Bar */
    .quick-actions {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: #181818;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .quick-action-btn {
      flex: 1;
      padding: 10px;
      background: #272727;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: background 0.2s;
    }

    .quick-action-btn:hover {
      background: #3f3f3f;
    }

    .quick-action-btn span:first-child {
      font-size: 18px;
    }

    /* Playlist Panel */
    .playlist-panel {
      background: #181818;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .playlist-header {
      background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
      padding: 16px;
    }

    .playlist-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .playlist-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      color: #aaa;
      margin-bottom: 4px;
    }

    .playlist-author a {
      color: #aaa;
      text-decoration: none;
    }

    .playlist-author a:hover {
      color: #fff;
    }

    .playlist-progress {
      color: #fff;
      font-weight: 500;
    }

    .playlist-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .control-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #aaa;
    }

    .control-toggle {
      position: relative;
      width: 36px;
      height: 20px;
      background: #717171;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .control-toggle.active {
      background: #3ea6ff;
    }

    .control-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      transition: left 0.2s;
    }

    .control-toggle.active::after {
      left: 18px;
    }

    .shuffle-btn, .loop-btn {
      background: none;
      border: none;
      color: #aaa;
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      transition: color 0.2s;
    }

    .shuffle-btn:hover, .loop-btn:hover {
      color: #fff;
    }

    .shuffle-btn.active, .loop-btn.active {
      color: #3ea6ff;
    }

    /* Playlist Videos - Hidden scrollbar */
    .playlist-videos {
      max-height: calc(100vh - 450px);
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .playlist-videos::-webkit-scrollbar {
      display: none;
    }

    .playlist-video-item {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      transition: background 0.2s;
      border-left: 3px solid transparent;
    }

    .playlist-video-item:hover {
      background: #272727;
    }

    .playlist-video-item.active {
      background: #272727;
      border-left-color: #3ea6ff;
    }

    .video-index {
      width: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #aaa;
      flex-shrink: 0;
    }

    .video-index.playing {
      color: #3ea6ff;
    }

    .playlist-video-thumb {
      position: relative;
      width: 100px;
      aspect-ratio: 16/9;
      border-radius: 8px;
      overflow: hidden;
      background: #333;
      flex-shrink: 0;
    }

    .playlist-video-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .playlist-video-duration {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 11px;
    }

    .playlist-video-info {
      flex: 1;
      min-width: 0;
    }

    .playlist-video-title {
      font-size: 13px;
      font-weight: 500;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 4px;
      color: #f1f1f1;
    }

    .playlist-video-author {
      font-size: 12px;
      color: #aaa;
    }

    /* Related Videos Section */
    .related-section {
      background: #181818;
      border-radius: 12px;
      padding: 16px;
    }

    .related-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #f1f1f1;
    }

    .related-videos {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .related-video-item {
      display: flex;
      gap: 8px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      transition: opacity 0.2s;
    }

    .related-video-item:hover {
      opacity: 0.8;
    }

    .related-video-thumb {
      position: relative;
      width: 168px;
      aspect-ratio: 16/9;
      border-radius: 8px;
      overflow: hidden;
      background: #333;
      flex-shrink: 0;
    }

    .related-video-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .related-video-duration {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 11px;
    }

    .related-video-info {
      flex: 1;
      min-width: 0;
    }

    .related-video-title {
      font-size: 14px;
      font-weight: 500;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 4px;
      color: #f1f1f1;
    }

    .related-video-channel {
      font-size: 12px;
      color: #aaa;
      margin-bottom: 2px;
    }

    .related-video-meta {
      font-size: 12px;
      color: #aaa;
    }

    /* Autoplay Overlay */
    .autoplay-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .autoplay-content {
      text-align: center;
      max-width: 400px;
      padding: 24px;
    }

    .autoplay-label {
      font-size: 12px;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
    }

    .autoplay-next-video {
      display: flex;
      gap: 12px;
      background: #272727;
      border-radius: 12px;
      padding: 12px;
      text-align: left;
      margin-bottom: 20px;
    }

    .autoplay-thumb {
      width: 120px;
      aspect-ratio: 16/9;
      border-radius: 8px;
      overflow: hidden;
      background: #333;
      flex-shrink: 0;
    }

    .autoplay-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .autoplay-info {
      flex: 1;
      min-width: 0;
    }

    .autoplay-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .autoplay-author {
      font-size: 12px;
      color: #aaa;
    }

    .autoplay-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .countdown-ring {
      position: relative;
      width: 60px;
      height: 60px;
    }

    .countdown-ring svg {
      transform: rotate(-90deg);
    }

    .countdown-ring circle {
      fill: none;
      stroke-width: 4;
    }

    .countdown-ring .bg {
      stroke: #333;
    }

    .countdown-ring .progress {
      stroke: #3ea6ff;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s linear;
    }

    .countdown-number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      font-weight: 600;
    }

    .autoplay-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .play-now-btn {
      background: #fff;
      color: #000;
    }

    .play-now-btn:hover {
      background: #d9d9d9;
    }

    .cancel-btn {
      background: #272727;
      color: #fff;
    }

    .cancel-btn:hover {
      background: #3f3f3f;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #aaa;
      background: #181818;
      border-radius: 12px;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      color: #fff;
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
      max-width: 300px;
      margin: 0 auto;
    }

    /* Comments Section */
    .comments-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #272727;
    }

    .comments-header {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 24px;
    }

    .comments-count {
      font-size: 16px;
      font-weight: 500;
    }

    .comments-sort {
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      color: #f1f1f1;
      font-size: 14px;
      cursor: pointer;
    }

    .comments-sort:hover {
      color: #fff;
    }

    .add-comment {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }

    .add-comment-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #3ea6ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .add-comment-input {
      flex: 1;
      background: none;
      border: none;
      border-bottom: 1px solid #272727;
      color: #fff;
      font-size: 14px;
      padding: 8px 0;
      outline: none;
      transition: border-color 0.2s;
    }

    .add-comment-input:focus {
      border-color: #fff;
    }

    .add-comment-input::placeholder {
      color: #717171;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #323232;
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 2000;
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    .toast-action {
      color: #3ea6ff;
      background: none;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    /* Hidden class */
    .hidden {
      display: none !important;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .sidebar {
        width: 350px;
      }

      .related-video-thumb {
        width: 140px;
      }
    }

    @media (max-width: 1000px) {
      .watch-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
      }

      .playlist-videos {
        max-height: 400px;
      }

      .related-video-thumb {
        width: 168px;
      }
    }

    @media (max-width: 768px) {
      .left-menu {
        transform: translateX(-100%);
        width: 200px;
      }

      .left-menu.open {
        transform: translateX(0);
      }

      .menu-overlay.open {
        display: block;
      }

      .main-wrapper {
        margin-left: 0;
      }

      .header-center {
        display: none;
      }

      .mobile-search-btn {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .menu-toggle {
        display: block;
      }

      .watch-container {
        padding: 16px;
        gap: 16px;
      }

      .video-title {
        font-size: 16px;
      }

      .video-stats {
        flex-direction: column;
        align-items: flex-start;
      }

      .video-actions {
        width: 100%;
        overflow-x: auto;
        padding-bottom: 8px;
        flex-wrap: nowrap;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .video-actions::-webkit-scrollbar {
        display: none;
      }

      .channel-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .channel-buttons {
        width: 100%;
      }

      .subscribe-btn {
        flex: 1;
      }

      .quick-actions {
        flex-wrap: wrap;
      }

      .quick-action-btn {
        flex: 1 1 calc(33.33% - 6px);
        min-width: calc(33.33% - 6px);
      }

      .related-video-item {
        flex-direction: row;
      }

      .related-video-thumb {
        width: 120px;
      }
    }

    @media (max-width: 480px) {
      .action-btn span:last-child {
        display: none;
      }

      .action-btn {
        padding: 10px 12px;
      }

      .autoplay-controls {
        flex-direction: column;
        gap: 12px;
      }

      .autoplay-next-video {
        flex-direction: column;
      }

      .autoplay-thumb {
        width: 100%;
      }

      .playlist-controls {
        flex-wrap: wrap;
        gap: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <button class="menu-toggle" id="menu-toggle" aria-label="Toggle menu">‚ò∞</button>
      <a href="/" class="logo">
        <div class="logo-icon">‚ñ∂</div>
        <span>YouTube</span>
      </a>
    </div>

    <!-- Desktop Search -->
    <div class="header-center">
      <form class="search-container" id="desktop-search-form">
        <div class="search-input-wrapper">
          <input type="text" class="search-input" id="desktop-search-input" placeholder="Search" autocomplete="off">
        </div>
        <button type="submit" class="search-btn" aria-label="Search">
          <svg viewBox="0 0 24 24">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
          </svg>
        </button>
      </form>
    </div>

    <!-- Mobile Search Button -->
    <div class="header-right">
      <button class="mobile-search-btn" id="mobile-search-btn" aria-label="Search">
        <svg viewBox="0 0 24 24">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
        </svg>
      </button>
    </div>
  </header>

  <!-- Mobile Search Bar -->
  <div class="mobile-search-container" id="mobile-search-container">
    <form class="mobile-search-wrapper" id="mobile-search-form">
      <input type="text" class="mobile-search-input" id="mobile-search-input" placeholder="Search" autocomplete="off">
      <button type="submit" class="mobile-search-submit" aria-label="Search">
        <svg viewBox="0 0 24 24">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
        </svg>
      </button>
      <button type="button" class="mobile-search-close" id="mobile-search-close" aria-label="Close search">‚úï</button>
    </form>
  </div>

  <!-- Left Menu - Same as channel/search pages -->
  <nav class="left-menu" id="left-menu">
    <a href="/" class="menu-item">
      <span class="menu-item-icon">üè†</span>
      <span>Home</span>
    </a>
    <a href="/shorts" class="menu-item">
      <span class="menu-item-icon">‚ö°</span>
      <span>Shorts</span>
    </a>
    <a href="/subscriptions" class="menu-item">
      <span class="menu-item-icon">üì∫</span>
      <span>Subscriptions</span>
    </a>
    
    <div class="menu-divider"></div>
    
    <div class="menu-section-title">You</div>
    <a href="/history" class="menu-item">
      <span class="menu-item-icon">‚è±Ô∏è</span>
      <span>History</span>
    </a>
    <a href="/playlists" class="menu-item">
      <span class="menu-item-icon">üìÅ</span>
      <span>Playlists</span>
    </a>
    <a href="/watch-later" class="menu-item">
      <span class="menu-item-icon">‚è∞</span>
      <span>Watch later</span>
    </a>
    <a href="/liked" class="menu-item">
      <span class="menu-item-icon">üëç</span>
      <span>Liked videos</span>
    </a>
    
    <div class="menu-divider"></div>
    
    <div class="menu-section-title">Explore</div>
    <a href="/trending" class="menu-item">
      <span class="menu-item-icon">üî•</span>
      <span>Trending</span>
    </a>
    <a href="/music" class="menu-item">
      <span class="menu-item-icon">üéµ</span>
      <span>Music</span>
    </a>
    <a href="/gaming" class="menu-item">
      <span class="menu-item-icon">üéÆ</span>
      <span>Gaming</span>
    </a>
    <a href="/sports" class="menu-item">
      <span class="menu-item-icon">‚öΩ</span>
      <span>Sports</span>
    </a>
  </nav>

  <!-- Menu Overlay for Mobile -->
  <div class="menu-overlay" id="menu-overlay"></div>

  <!-- Main Wrapper -->
  <div class="main-wrapper">
    <!-- Loading State -->
    <div id="loading" class="loading-container">
      <div class="spinner"></div>
      <p>Loading...</p>
    </div>

    <!-- Main Content -->
    <div id="content" class="hidden">
      <div class="watch-container">
        <!-- Player Section -->
        <div class="player-section">
          <div class="video-player-container" id="player-container">
            <!-- Player Placeholder -->
            <div class="player-placeholder" id="player-placeholder">
              <div class="player-placeholder-icon">üé¨</div>
              <h2>Ready to watch?</h2>
              <p>Search for a video or paste a YouTube playlist URL/ID in the search bar to get started.</p>
            </div>
            <div id="player"></div>
            
            <!-- Autoplay Overlay -->
            <div class="autoplay-overlay hidden" id="autoplay-overlay">
              <div class="autoplay-content">
                <p class="autoplay-label">Up Next</p>
                <div class="autoplay-next-video">
                  <div class="autoplay-thumb">
                    <img id="autoplay-thumb" src="" alt="">
                  </div>
                  <div class="autoplay-info">
                    <h4 class="autoplay-title" id="autoplay-title"></h4>
                    <p class="autoplay-author" id="autoplay-author"></p>
                  </div>
                </div>
                <div class="autoplay-controls">
                  <div class="countdown-ring">
                    <svg width="60" height="60">
                      <circle class="bg" cx="30" cy="30" r="26"></circle>
                      <circle class="progress" id="countdown-progress" cx="30" cy="30" r="26" 
                        stroke-dasharray="163.36" stroke-dashoffset="0"></circle>
                    </svg>
                    <span class="countdown-number" id="countdown-number">5</span>
                  </div>
                  <button class="autoplay-btn play-now-btn" id="play-now-btn">Play Now</button>
                  <button class="autoplay-btn cancel-btn" id="cancel-autoplay-btn">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Video Info -->
          <div class="video-info" id="video-info-section">
            <h1 class="video-title" id="video-title">Select a video to play</h1>
            <div class="video-stats">
              <div class="video-meta">
                <span id="video-views"></span>
                <span id="video-date"></span>
              </div>
              <div class="video-actions">
                <button class="action-btn" id="like-btn">
                  <span>üëç</span>
                  <span id="like-count">Like</span>
                </button>
                <button class="action-btn" id="dislike-btn">
                  <span>üëé</span>
                  <span>Dislike</span>
                </button>
                <button class="action-btn" id="share-btn">
                  <span>‚ÜóÔ∏è</span>
                  <span>Share</span>
                </button>
                <button class="action-btn" id="save-btn">
                  <span>üì•</span>
                  <span>Save</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Channel Info -->
          <div class="channel-row" id="channel-row">
            <div class="channel-info">
              <img class="channel-avatar" id="channel-avatar" src="" alt="Channel">
              <div class="channel-details">
                <h3><a id="channel-name" href="#">Channel Name</a></h3>
                <p class="channel-subs" id="channel-subs"></p>
              </div>
            </div>
            <div class="channel-buttons">
              <button class="subscribe-btn" id="subscribe-btn">Subscribe</button>
            </div>
          </div>

          <!-- Description -->
          <div class="description-box" id="description-box">
            <div class="description-meta">
              <span id="desc-views"></span> <span id="desc-date"></span>
            </div>
            <p class="description-text" id="video-description"></p>
            <button class="show-more-btn hidden" id="desc-toggle">Show more</button>
          </div>

          <!-- Comments Section -->
          <div class="comments-section" id="comments-section">
            <div class="comments-header">
              <span class="comments-count" id="comments-count">Comments</span>
              <button class="comments-sort">
                <span>‚áÖ</span>
                <span>Sort by</span>
              </button>
            </div>
            <div class="add-comment">
              <div class="add-comment-avatar">Y</div>
              <input type="text" class="add-comment-input" placeholder="Add a comment...">
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
          <!-- Quick Actions -->
          <div class="quick-actions">
            <button class="quick-action-btn" id="paste-playlist-btn">
              <span>üìã</span>
              <span>Paste Playlist</span>
            </button>
            <button class="quick-action-btn" id="clear-playlist-btn">
              <span>üóëÔ∏è</span>
              <span>Clear</span>
            </button>
            <button class="quick-action-btn" id="shuffle-all-btn">
              <span>üîÄ</span>
              <span>Shuffle</span>
            </button>
          </div>

          <!-- Playlist Panel -->
          <div class="playlist-panel hidden" id="playlist-panel">
            <div class="playlist-header">
              <h2 class="playlist-title" id="playlist-title"></h2>
              <div class="playlist-info">
                <span class="playlist-author" id="playlist-author"></span>
                <span class="playlist-progress" id="playlist-progress"></span>
              </div>
              <div class="playlist-controls">
                <button class="shuffle-btn" id="shuffle-btn" title="Shuffle">üîÄ</button>
                <div class="control-item">
                  <span>Loop</span>
                  <div class="control-toggle" id="loop-toggle"></div>
                </div>
                <div class="control-item">
                  <span>Autoplay</span>
                  <div class="control-toggle active" id="autoplay-toggle"></div>
                </div>
              </div>
            </div>
            <div class="playlist-videos" id="playlist-videos"></div>
          </div>

          <!-- Empty State -->
          <div class="empty-state" id="empty-state">
            <div class="empty-state-icon">üìù</div>
            <h3>No playlist loaded</h3>
            <p>Search or paste a YouTube playlist URL to load videos here.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span id="toast-message"></span>
    <button class="toast-action hidden" id="toast-action"></button>
  </div>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  
  <script>
    const API_BASE = 'https://9fecd8f8-cc38-4ee3-a55a-0e61e94dafe5-00-24aic6pbf1rh0.sisko.replit.dev/api/channel';

    // State
    let player = null;
    let playerReady = false;
    let currentVideoId = null;
    let currentPlaylistId = null;
    let playlistData = null;
    let currentPlaylistIndex = 0;
    let autoplayEnabled = true;
    let loopEnabled = false;
    let shuffleEnabled = false;
    let shuffledOrder = [];
    let countdownInterval = null;
    let countdownSeconds = 5;
    let menuOpen = false;
    let mobileSearchOpen = false;

    // DOM Elements
    const menuToggle = document.getElementById('menu-toggle');
    const leftMenu = document.getElementById('left-menu');
    const menuOverlay = document.getElementById('menu-overlay');
    const mobileSearchBtn = document.getElementById('mobile-search-btn');
    const mobileSearchContainer = document.getElementById('mobile-search-container');
    const mobileSearchClose = document.getElementById('mobile-search-close');
    const desktopSearchForm = document.getElementById('desktop-search-form');
    const desktopSearchInput = document.getElementById('desktop-search-input');
    const mobileSearchForm = document.getElementById('mobile-search-form');
    const mobileSearchInput = document.getElementById('mobile-search-input');

    // Menu toggle functionality
    function toggleMenu() {
      menuOpen = !menuOpen;
      leftMenu.classList.toggle('open', menuOpen);
      menuOverlay.classList.toggle('open', menuOpen);
    }

    menuToggle.addEventListener('click', toggleMenu);
    menuOverlay.addEventListener('click', toggleMenu);

    // Mobile search functionality
    function openMobileSearch() {
      mobileSearchOpen = true;
      mobileSearchContainer.classList.add('open');
      mobileSearchInput.focus();
    }

    function closeMobileSearch() {
      mobileSearchOpen = false;
      mobileSearchContainer.classList.remove('open');
    }

    mobileSearchBtn.addEventListener('click', openMobileSearch);
    mobileSearchClose.addEventListener('click', closeMobileSearch);

    // Search functionality
    function performSearch(query) {
      if (query && query.trim()) {
        const playlistId = extractPlaylistId(query);
        const videoId = extractVideoId(query);
        
        if (playlistId) {
          const alsoHasVideo = videoId && !query.includes('playlist?');
          if (alsoHasVideo) {
            currentVideoId = videoId;
            initPlayer(videoId);
            loadVideoData(videoId);
          }
          loadPlaylist(playlistId, 0, !alsoHasVideo);
        } else if (videoId) {
          initPlayer(videoId);
          loadVideoData(videoId);
          updateURL(videoId);
          playlistData = null;
          document.getElementById('playlist-panel').classList.add('hidden');
          document.getElementById('empty-state').classList.remove('hidden');
        } else {
          window.location.href = `/search?q=${encodeURIComponent(query.trim())}`;
        }
      }
    }

    desktopSearchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      performSearch(desktopSearchInput.value);
    });

    mobileSearchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      performSearch(mobileSearchInput.value);
      closeMobileSearch();
    });

    // Close menu on window resize
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        if (menuOpen) {
          menuOpen = false;
          leftMenu.classList.remove('open');
          menuOverlay.classList.remove('open');
        }
        if (mobileSearchOpen) {
          closeMobileSearch();
        }
      }
    });

    // Get URL parameters
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        videoId: params.get('v'),
        playlistId: params.get('list'),
        index: parseInt(params.get('index')) || 0
      };
    }

    // Update URL
    function updateURL(videoId, playlistId = null, index = null) {
      let url = `/watch?v=${videoId}`;
      if (playlistId) {
        url += `&list=${playlistId}`;
        if (index !== null && index > 0) {
          url += `&index=${index}`;
        }
      }
      window.history.pushState({}, '', url);
    }

    // Fix thumbnail URLs
    function fixThumbnailUrl(url) {
      if (!url) return 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 9"><rect fill="%23333" width="16" height="9"/></svg>';
      if (url.startsWith('//')) return 'https:' + url;
      return url;
    }

    // Escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Show toast notification
    function showToast(message, action = null, actionText = null) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      const toastAction = document.getElementById('toast-action');
      
      toastMessage.textContent = message;
      
      if (action && actionText) {
        toastAction.textContent = actionText;
        toastAction.classList.remove('hidden');
        toastAction.onclick = action;
      } else {
        toastAction.classList.add('hidden');
      }
      
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    // Extract playlist ID
    function extractPlaylistId(input) {
      if (!input) return null;
      input = input.trim();
      
      if (/^[A-Za-z0-9_-]{10,}$/.test(input) && !input.includes('/')) {
        return input;
      }
      
      const patterns = [
        /[?&]list=([A-Za-z0-9_-]+)/,
        /youtube\.com\/playlist\?list=([A-Za-z0-9_-]+)/,
        /youtu\.be\/.*[?&]list=([A-Za-z0-9_-]+)/
      ];
      
      for (const pattern of patterns) {
        const match = input.match(pattern);
        if (match) return match[1];
      }
      
      return null;
    }

    // Extract video ID
    function extractVideoId(input) {
      if (!input) return null;
      input = input.trim();
      
      if (/^[A-Za-z0-9_-]{11}$/.test(input)) {
        return input;
      }
      
      const patterns = [
        /[?&]v=([A-Za-z0-9_-]{11})/,
        /youtu\.be\/([A-Za-z0-9_-]{11})/,
        /youtube\.com\/embed\/([A-Za-z0-9_-]{11})/,
        /youtube\.com\/shorts\/([A-Za-z0-9_-]{11})/
      ];
      
      for (const pattern of patterns) {
        const match = input.match(pattern);
        if (match) return match[1];
      }
      
      return null;
    }

    // YouTube Player API Ready
    function onYouTubeIframeAPIReady() {
      playerReady = true;
      
      const params = getUrlParams();
      
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
      
      if (params.videoId) {
        initPlayer(params.videoId);
        loadVideoData(params.videoId);
        
        if (params.playlistId) {
          loadPlaylist(params.playlistId, params.index);
        }
      } else if (params.playlistId) {
        loadPlaylist(params.playlistId, 0, true);
      }
    }

    // Initialize YouTube Player
    function initPlayer(videoId) {
      document.getElementById('player-placeholder').classList.add('hidden');
      
      if (player) {
        player.loadVideoById(videoId);
        return;
      }
      
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: videoId,
        playerVars: {
          'autoplay': 1,
          'rel': 0,
          'modestbranding': 1,
          'playsinline': 1,
          'enablejsapi': 1
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange,
          'onError': onPlayerError
        }
      });
    }

    function onPlayerReady(event) {
      event.target.playVideo();
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        handleVideoEnded();
      }
      if (event.data === YT.PlayerState.PLAYING) {
        cancelAutoplayCountdown();
      }
    }

    function onPlayerError(event) {
      console.error('Player error:', event.data);
      showToast('Error playing video. Trying next...');
      if (playlistData && autoplayEnabled) {
        setTimeout(() => playNextVideo(), 2000);
      }
    }

    function handleVideoEnded() {
      if (!autoplayEnabled || !playlistData) return;
      const nextIndex = getNextVideoIndex();
      if (nextIndex !== null) {
        startAutoplayCountdown(nextIndex);
      } else {
        showToast('Playlist ended');
      }
    }

    function getNextVideoIndex() {
      if (!playlistData || !playlistData.videos) return null;
      const order = shuffleEnabled ? shuffledOrder : [...Array(playlistData.videos.length).keys()];
      const currentOrderIndex = order.indexOf(currentPlaylistIndex);
      const nextOrderIndex = currentOrderIndex + 1;
      
      if (nextOrderIndex < order.length) {
        return order[nextOrderIndex];
      } else if (loopEnabled) {
        return order[0];
      }
      return null;
    }

    function startAutoplayCountdown(nextIndex) {
      const nextVideo = playlistData.videos[nextIndex];
      if (!nextVideo) return;
      
      document.getElementById('autoplay-thumb').src = fixThumbnailUrl(nextVideo.img || nextVideo.thumbnail);
      document.getElementById('autoplay-title').textContent = nextVideo.title;
      document.getElementById('autoplay-author').textContent = nextVideo.author || playlistData.author || '';
      document.getElementById('autoplay-overlay').classList.remove('hidden');
      
      countdownSeconds = 5;
      updateCountdown();
      
      countdownInterval = setInterval(() => {
        countdownSeconds--;
        updateCountdown();
        if (countdownSeconds <= 0) {
          cancelAutoplayCountdown();
          playVideoFromPlaylist(nextIndex);
        }
      }, 1000);
    }

    function updateCountdown() {
      document.getElementById('countdown-number').textContent = countdownSeconds;
      const progress = document.getElementById('countdown-progress');
      const circumference = 163.36;
      const offset = circumference - (countdownSeconds / 5) * circumference;
      progress.style.strokeDashoffset = offset;
    }

    function cancelAutoplayCountdown() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      document.getElementById('autoplay-overlay').classList.add('hidden');
    }

    function playNextVideo() {
      const nextIndex = getNextVideoIndex();
      if (nextIndex !== null) {
        playVideoFromPlaylist(nextIndex);
      }
    }

    async function loadVideoData(videoId) {
      currentVideoId = videoId;
      try {
        const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
        const data = await response.json();
        
        document.getElementById('video-title').textContent = data.title || 'Video';
        document.getElementById('channel-name').textContent = data.author_name || 'Channel';
        document.getElementById('channel-name').href = data.author_url || '#';
        document.getElementById('channel-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(data.author_name || 'C')}&background=ff0000&color=fff&size=48`;
        document.title = `${data.title} - YouTube`;
      } catch (error) {
        console.error('Error loading video data:', error);
      }
    }

    async function loadPlaylist(playlistId, startIndex = 0, autoPlayFirst = false) {
      currentPlaylistId = playlistId;
      showToast('Loading playlist...');
      
      try {
        const response = await fetch(`${API_BASE}/playlist/${playlistId}`);
        const data = await response.json();
        
        if (data && data.videos && data.videos.length > 0) {
          playlistData = data;
          shuffledOrder = [...Array(data.videos.length).keys()];
          
          document.getElementById('empty-state').classList.add('hidden');
          document.getElementById('playlist-panel').classList.remove('hidden');
          
          document.getElementById('playlist-title').textContent = data.title || 'Playlist';
          document.getElementById('playlist-author').innerHTML = data.author ? 
            `<a href="/@${data.author}">${escapeHtml(data.author)}</a>` : '';
          
          renderPlaylistVideos();
          
          if (currentVideoId) {
            const idx = data.videos.findIndex(v => v.id === currentVideoId);
            if (idx !== -1) currentPlaylistIndex = idx;
          } else {
            currentPlaylistIndex = startIndex;
          }
          
          updatePlaylistProgress();
          highlightCurrentVideo();
          
          if (autoPlayFirst) {
            playVideoFromPlaylist(currentPlaylistIndex);
          }
          
          showToast(`Loaded ${data.videos.length} videos`);
        } else {
          showToast('Playlist not found or empty');
        }
      } catch (error) {
        console.error('Error loading playlist:', error);
        showToast('Failed to load playlist');
      }
    }

    function renderPlaylistVideos() {
      const container = document.getElementById('playlist-videos');
      container.innerHTML = '';
      
      const order = shuffleEnabled ? shuffledOrder : [...Array(playlistData.videos.length).keys()];
      
      order.forEach((videoIndex, displayIndex) => {
        const video = playlistData.videos[videoIndex];
        const item = document.createElement('div');
        item.className = 'playlist-video-item' + (videoIndex === currentPlaylistIndex ? ' active' : '');
        item.dataset.index = videoIndex;
        item.onclick = () => playVideoFromPlaylist(videoIndex);
        
        item.innerHTML = `
          <div class="video-index ${videoIndex === currentPlaylistIndex ? 'playing' : ''}">
            ${videoIndex === currentPlaylistIndex ? '‚ñ∂' : displayIndex + 1}
          </div>
          <div class="playlist-video-thumb">
            <img src="${fixThumbnailUrl(video.img || video.thumbnail)}" alt="" loading="lazy">
            ${video.duration ? `<span class="playlist-video-duration">${video.duration}</span>` : ''}
          </div>
          <div class="playlist-video-info">
            <h4 class="playlist-video-title">${escapeHtml(video.title)}</h4>
            <p class="playlist-video-author">${escapeHtml(video.author || playlistData.author || '')}</p>
          </div>
        `;
        container.appendChild(item);
      });
    }

    function playVideoFromPlaylist(index) {
      if (!playlistData || !playlistData.videos[index]) return;
      
      cancelAutoplayCountdown();
      
      const video = playlistData.videos[index];
      currentPlaylistIndex = index;
      currentVideoId = video.id;
      
      updateURL(video.id, currentPlaylistId, index);
      
      if (player && typeof player.loadVideoById === 'function') {
        player.loadVideoById(video.id);
      } else {
        initPlayer(video.id);
      }
      
      document.getElementById('video-title').textContent = video.title;
      document.getElementById('channel-name').textContent = video.author || playlistData.author || 'Channel';
      document.title = `${video.title} - YouTube`;
      
      updatePlaylistProgress();
      highlightCurrentVideo();
      scrollToCurrentVideo();
    }

    function updatePlaylistProgress() {
      if (playlistData) {
        document.getElementById('playlist-progress').textContent = 
          `${currentPlaylistIndex + 1} / ${playlistData.videos.length}`;
      }
    }

    function highlightCurrentVideo() {
      const items = document.querySelectorAll('.playlist-video-item');
      items.forEach(item => {
        const idx = parseInt(item.dataset.index);
        const isActive = idx === currentPlaylistIndex;
        item.classList.toggle('active', isActive);
        
        const indexEl = item.querySelector('.video-index');
        indexEl.classList.toggle('playing', isActive);
        indexEl.textContent = isActive ? '‚ñ∂' : (shuffleEnabled ? 
          shuffledOrder.indexOf(idx) + 1 : idx + 1);
      });
    }

    function scrollToCurrentVideo() {
      const container = document.getElementById('playlist-videos');
      const activeItem = container.querySelector('.playlist-video-item.active');
      if (activeItem) {
        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function shufflePlaylist() {
      if (!playlistData) return;
      
      shuffleEnabled = !shuffleEnabled;
      document.getElementById('shuffle-btn').classList.toggle('active', shuffleEnabled);
      
      if (shuffleEnabled) {
        shuffledOrder = [...Array(playlistData.videos.length).keys()];
        for (let i = shuffledOrder.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffledOrder[i], shuffledOrder[j]] = [shuffledOrder[j], shuffledOrder[i]];
        }
        const currentIdx = shuffledOrder.indexOf(currentPlaylistIndex);
        if (currentIdx > 0) {
          shuffledOrder.splice(currentIdx, 1);
          shuffledOrder.unshift(currentPlaylistIndex);
        }
        showToast('Shuffle enabled');
      } else {
        shuffledOrder = [...Array(playlistData.videos.length).keys()];
        showToast('Shuffle disabled');
      }
      
      renderPlaylistVideos();
      highlightCurrentVideo();
    }

    async function pasteFromClipboard() {
      try {
        const text = await navigator.clipboard.readText();
        desktopSearchInput.value = text;
        performSearch(text);
      } catch (error) {
        showToast('Unable to access clipboard. Please paste manually.');
      }
    }

    function clearPlaylist() {
      playlistData = null;
      currentPlaylistId = null;
      shuffledOrder = [];
      
      document.getElementById('playlist-panel').classList.add('hidden');
      document.getElementById('empty-state').classList.remove('hidden');
      
      if (currentVideoId) updateURL(currentVideoId);
      showToast('Playlist cleared');
    }

    // Setup event listeners
    function setupEventListeners() {
      document.getElementById('paste-playlist-btn').onclick = pasteFromClipboard;
      document.getElementById('clear-playlist-btn').onclick = clearPlaylist;
      document.getElementById('shuffle-all-btn').onclick = shufflePlaylist;
      document.getElementById('shuffle-btn').onclick = shufflePlaylist;
      
      document.getElementById('loop-toggle').onclick = function() {
        loopEnabled = !loopEnabled;
        this.classList.toggle('active', loopEnabled);
        showToast(loopEnabled ? 'Loop enabled' : 'Loop disabled');
      };
      
      document.getElementById('autoplay-toggle').onclick = function() {
        autoplayEnabled = !autoplayEnabled;
        this.classList.toggle('active', autoplayEnabled);
        showToast(autoplayEnabled ? 'Autoplay enabled' : 'Autoplay disabled');
      };
      
      document.getElementById('play-now-btn').onclick = () => {
        const nextIndex = getNextVideoIndex();
        if (nextIndex !== null) {
          cancelAutoplayCountdown();
          playVideoFromPlaylist(nextIndex);
        }
      };
      
      document.getElementById('cancel-autoplay-btn').onclick = cancelAutoplayCountdown;
      
      document.getElementById('description-box').onclick = function() {
        const desc = document.getElementById('video-description');
        const toggle = document.getElementById('desc-toggle');
        if (!this.classList.contains('expanded')) {
          desc.classList.add('expanded');
          this.classList.add('expanded');
          toggle.textContent = 'Show less';
          toggle.classList.remove('hidden');
        }
      };
      
      document.getElementById('desc-toggle').onclick = function(e) {
        e.stopPropagation();
        const desc = document.getElementById('video-description');
        const box = document.getElementById('description-box');
        desc.classList.toggle('expanded');
        box.classList.toggle('expanded');
        this.textContent = desc.classList.contains('expanded') ? 'Show less' : 'Show more';
      };
      
      document.getElementById('like-btn').onclick = function() {
        this.classList.toggle('liked');
        showToast(this.classList.contains('liked') ? 'Added to liked videos' : 'Removed from liked videos');
      };
      
      document.getElementById('subscribe-btn').onclick = function() {
        this.classList.toggle('subscribed');
        this.textContent = this.classList.contains('subscribed') ? 'Subscribed' : 'Subscribe';
        showToast(this.classList.contains('subscribed') ? 'Subscribed!' : 'Unsubscribed');
      };
      
      document.getElementById('share-btn').onclick = () => {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
          showToast('Link copied to clipboard');
        }).catch(() => {
          showToast('Failed to copy link');
        });
      };
      
      document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;
        
        switch(e.key) {
          case 'n':
          case 'N':
            if (e.shiftKey) playNextVideo();
            break;
          case 'p':
          case 'P':
            if (e.shiftKey) {
              const prevIndex = currentPlaylistIndex - 1;
              if (prevIndex >= 0) playVideoFromPlaylist(prevIndex);
            }
            break;
          case 's':
          case 'S':
            if (e.shiftKey) shufflePlaylist();
            break;
          case 'l':
          case 'L':
            if (e.shiftKey) {
              loopEnabled = !loopEnabled;
              document.getElementById('loop-toggle').classList.toggle('active', loopEnabled);
              showToast(loopEnabled ? 'Loop enabled' : 'Loop disabled');
            }
            break;
          case 'Escape':
            if (mobileSearchOpen) closeMobileSearch();
            break;
        }
      });
      
      window.addEventListener('popstate', () => {
        const params = getUrlParams();
        if (params.videoId && params.videoId !== currentVideoId) {
          if (player) {
            player.loadVideoById(params.videoId);
            currentVideoId = params.videoId;
            loadVideoData(params.videoId);
          }
          if (params.playlistId && params.playlistId === currentPlaylistId) {
            currentPlaylistIndex = params.index || 0;
            updatePlaylistProgress();
            highlightCurrentVideo();
          }
        }
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      if (window.YT && window.YT.Player) {
        onYouTubeIframeAPIReady();
      }
    });
    
    setTimeout(() => {
      if (!playerReady) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
      }
    }, 3000);
  </script>
</body>
</html>
